<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>O2: Low-Level Message Parsing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo-small.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">O2
   &#160;<span id="projectnumber">1.1</span>
   </div>
   <div id="projectbrief">Inter-process communication system for media applications</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">Low-Level Message Parsing</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga5743585b7234221d61a9631506403bb9"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__lowlevelparse.html#ga5743585b7234221d61a9631506403bb9">o2_extract_start</a> (<a class="el" href="structo2__msg__data.html">o2_msg_data_ptr</a> msg)</td></tr>
<tr class="memdesc:ga5743585b7234221d61a9631506403bb9"><td class="mdescLeft">&#160;</td><td class="mdescRight">initialize internal state to parse, extract, and coerce message arguments.  <a href="#ga5743585b7234221d61a9631506403bb9">More...</a><br /></td></tr>
<tr class="separator:ga5743585b7234221d61a9631506403bb9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga86bb7c2ff32557228d4714f67378c649"><td class="memItemLeft" align="right" valign="top"><a class="el" href="uniono2__arg.html">o2_arg_ptr</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__lowlevelparse.html#ga86bb7c2ff32557228d4714f67378c649">o2_get_next</a> (<a class="el" href="group__basics.html#gadf84af81a4f69b65b351008e3146279f">o2_type</a> type_code)</td></tr>
<tr class="memdesc:ga86bb7c2ff32557228d4714f67378c649"><td class="mdescLeft">&#160;</td><td class="mdescRight">get the next message parameter  <a href="#ga86bb7c2ff32557228d4714f67378c649">More...</a><br /></td></tr>
<tr class="separator:ga86bb7c2ff32557228d4714f67378c649"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>These functions can retrieve message arguments one-at-a-time. There are some hidden state variables to keep track of the state of unpacking, so these functions are not reentrant. Arguments are returned using a pointer to a union type: #o2_arg_ptr. </p>
<h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="ga5743585b7234221d61a9631506403bb9"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int o2_extract_start </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structo2__msg__data.html">o2_msg_data_ptr</a>&#160;</td>
          <td class="paramname"><em>msg</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>initialize internal state to parse, extract, and coerce message arguments. </p>
<dl class="section return"><dt>Returns</dt><dd>length of the type string in msg</dd></dl>
<p>To get arguments from a message, call <a class="el" href="group__lowlevelparse.html#ga5743585b7234221d61a9631506403bb9" title="initialize internal state to parse, extract, and coerce message arguments. ">o2_extract_start()</a>, then for each parameter, call <a class="el" href="group__lowlevelparse.html#ga86bb7c2ff32557228d4714f67378c649" title="get the next message parameter ">o2_get_next()</a>. </p>

</div>
</div>
<a class="anchor" id="ga86bb7c2ff32557228d4714f67378c649"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="uniono2__arg.html">o2_arg_ptr</a> o2_get_next </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__basics.html#gadf84af81a4f69b65b351008e3146279f">o2_type</a>&#160;</td>
          <td class="paramname"><em>type_code</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>get the next message parameter </p>
<p>This function is called repeatedly to obtain parameters in order from the message passed to <a class="el" href="group__lowlevelparse.html#ga5743585b7234221d61a9631506403bb9" title="initialize internal state to parse, extract, and coerce message arguments. ">o2_extract_start()</a>.</p>
<p>If the message parameter type matches the <code>type_code</code>, a pointer to the parameter is returned. If the types do not match, but coercion is possible, the parameter is coerced, copied to a new location, and a pointer is returned. Otherwise, NULL is returned.</p>
<p>The type of any non-NULL return value always matches the type specified by the parameter <code>type_code</code>. To determine the original type of the parameter as specified by the message, use the <code>types</code> string which is passed to message handlers. (Or course, this assumes that message type strings are correct. Badly formed messages are detected when the type string and data imply that the message is longer than the actual length, but otherwise there is no way to detect errors in type strings.)</p>
<p>The result points into the message or to a statically allocated buffer if type coercion is required. This storage is valid until the next call to <code>o2_extract_start</code>. If the value is a pointer (string, symbol, midi data, blob), then the value was not copied and remains in place within the message, so there should never be the need to immediately copy the data pointed to. However, since the storage for the value is the message, and the message will be freed when the handler returns, pointers to strings, symbols, midi data, and blobs <em>must not</em> be used after the handler returns.</p>
<h3>Example 1: Simple but not completely robust</h3>
<p>Note: call <a class="el" href="group__basics.html#ga5681e480b085ea6552a2456f1a3709de" title="Add a handler for an address. ">o2_method_new()</a> with type_spec = "id", h = my_handler, coerce = false, parse = false. In this case, since there is no type coercion, type_spec must match the message exactly, so <a class="el" href="group__lowlevelparse.html#ga86bb7c2ff32557228d4714f67378c649" title="get the next message parameter ">o2_get_next()</a> should always return a non-null o2_arg_ptr. However, this code can fail if a badly formed message is sent because there is no test for the NULL value that will be returned by <a class="el" href="group__lowlevelparse.html#ga86bb7c2ff32557228d4714f67378c649" title="get the next message parameter ">o2_get_next()</a>. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> my_handler(o2_message_ptr msg, <span class="keywordtype">char</span> *types,</div><div class="line">               o2_arg_ptr *argv, <span class="keywordtype">int</span> argc, <span class="keywordtype">void</span> *user_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group__lowlevelparse.html#ga5743585b7234221d61a9631506403bb9">o2_extract_start</a>(msg);</div><div class="line">    <span class="comment">// we expect an int32 and a double argument</span></div><div class="line">    int32_t my_int = <a class="code" href="group__lowlevelparse.html#ga86bb7c2ff32557228d4714f67378c649">o2_get_next</a>(<a class="code" href="group__basics.html#ggadf84af81a4f69b65b351008e3146279fa7a4c57b8137f8280de6cdd1bb1951c12">O2_INT32</a>)-&gt;<a class="code" href="uniono2__arg.html#a9183041de7aec86af61a14ffe5f3758e">i32</a>;</div><div class="line">    <span class="keywordtype">double</span> my_double = <a class="code" href="group__lowlevelparse.html#ga86bb7c2ff32557228d4714f67378c649">o2_get_next</a>(<a class="code" href="group__basics.html#ggadf84af81a4f69b65b351008e3146279fa55a97103f771efb8d069ce96f1f3aae2">O2_DOUBLE</a>)-&gt;<a class="code" href="uniono2__arg.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>;</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><h3>Example 2: Type coercion and type checking.</h3>
<p>Note: call <a class="el" href="group__basics.html#ga5681e480b085ea6552a2456f1a3709de" title="Add a handler for an address. ">o2_method_new()</a> with type_spec = NULL, h = my_handler, coerce = false, parse = false. In this case, even though coerce is false, there is no type_spec, so the handler will be called without type checking. We could check the actual message types (given by types), but here, we will coerce into our desired types (int32 and double) if possible. Since type coercion can fail (e.g. string will not be converted to number, not even "123"), we need to check the return value from <a class="el" href="group__lowlevelparse.html#ga86bb7c2ff32557228d4714f67378c649" title="get the next message parameter ">o2_get_next()</a>, where NULL indicates incompatible types. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> my_handler(o2_message_ptr msg, <span class="keywordtype">char</span> *types,</div><div class="line">               o2_arg_ptr *argv, <span class="keywordtype">int</span> argc, <span class="keywordtype">void</span> *user_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group__lowlevelparse.html#ga5743585b7234221d61a9631506403bb9">o2_extract_start</a>(msg);</div><div class="line">    <span class="comment">// we want to get an int32 and a double argument</span></div><div class="line">    o2_arg_ptr ap = <a class="code" href="group__lowlevelparse.html#ga86bb7c2ff32557228d4714f67378c649">o2_get_next</a>(<a class="code" href="group__basics.html#ggadf84af81a4f69b65b351008e3146279fa7a4c57b8137f8280de6cdd1bb1951c12">O2_INT32</a>);</div><div class="line">    <span class="keywordflow">if</span> (!ap) <span class="keywordflow">return</span> <a class="code" href="group__returncodes.html#ga8f5f040b03042ee184f7f5bae734026d">O2_FAIL</a>; <span class="comment">// parameter cannot be coerced</span></div><div class="line">    int32_t my_int = ap-&gt;<a class="code" href="uniono2__arg.html#a9183041de7aec86af61a14ffe5f3758e">i32</a>;</div><div class="line">    o2_arg_ptr ap = <a class="code" href="group__lowlevelparse.html#ga86bb7c2ff32557228d4714f67378c649">o2_get_next</a>(<a class="code" href="group__basics.html#ggadf84af81a4f69b65b351008e3146279fa55a97103f771efb8d069ce96f1f3aae2">O2_DOUBLE</a>);</div><div class="line">    <span class="keywordflow">if</span> (!ap) <span class="keywordflow">return</span> <a class="code" href="group__returncodes.html#ga8f5f040b03042ee184f7f5bae734026d">O2_FAIL</a>; <span class="comment">// parameter cannot be coerced</span></div><div class="line">    <span class="keywordtype">double</span> my_double = ap-&gt;<a class="code" href="uniono2__arg.html#a873684cefeb665f3d5e6b495de57fc0d">d</a>;</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">type_code</td><td>the desired parameter type</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the next message parameter or NULL if no more parameters </dd></dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
