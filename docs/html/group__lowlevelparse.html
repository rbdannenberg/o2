<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>O2: Low-Level Message Parsing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="o2.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">O2<span id="projectnumber">&#160;2.0</span>
   </div>
   <div id="projectbrief">A communication protocol for interactive music and media applications.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">Low-Level Message Parsing</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga5743585b7234221d61a9631506403bb9"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__lowlevelparse.html#ga5743585b7234221d61a9631506403bb9">o2_extract_start</a> (<a class="el" href="struct_o2msg__data.html">o2_msg_data_ptr</a> msg)</td></tr>
<tr class="memdesc:ga5743585b7234221d61a9631506403bb9"><td class="mdescLeft">&#160;</td><td class="mdescRight">initialize internal state to parse, extract, and coerce message arguments.  <a href="group__lowlevelparse.html#ga5743585b7234221d61a9631506403bb9">More...</a><br /></td></tr>
<tr class="separator:ga5743585b7234221d61a9631506403bb9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga639a79ba06d7bf9fda5f255b00e663b4"><td class="memItemLeft" align="right" valign="top"><a class="el" href="union_o2arg.html">O2arg_ptr</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__lowlevelparse.html#ga639a79ba06d7bf9fda5f255b00e663b4">o2_get_next</a> (<a class="el" href="group__basics.html#ga19ed1e45bd9c566270c0836d9ec95155">O2type</a> type_code)</td></tr>
<tr class="memdesc:ga639a79ba06d7bf9fda5f255b00e663b4"><td class="mdescLeft">&#160;</td><td class="mdescRight">get the next message parameter  <a href="group__lowlevelparse.html#ga639a79ba06d7bf9fda5f255b00e663b4">More...</a><br /></td></tr>
<tr class="separator:ga639a79ba06d7bf9fda5f255b00e663b4"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p >These functions can retrieve message arguments one-at-a-time. There are some hidden state variables to keep track of the state of unpacking, so these functions are not reentrant. Arguments are returned using a pointer to a union type: #O2arg_ptr. </p>
<h2 class="groupheader">Function Documentation</h2>
<a id="ga5743585b7234221d61a9631506403bb9" name="ga5743585b7234221d61a9631506403bb9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga5743585b7234221d61a9631506403bb9">&#9670;&nbsp;</a></span>o2_extract_start()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int o2_extract_start </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="struct_o2msg__data.html">o2_msg_data_ptr</a>&#160;</td>
          <td class="paramname"><em>msg</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>initialize internal state to parse, extract, and coerce message arguments. </p>
<dl class="section return"><dt>Returns</dt><dd>length of the type string in msg</dd></dl>
<p>To get arguments from a message, call <a class="el" href="group__lowlevelparse.html#ga5743585b7234221d61a9631506403bb9" title="initialize internal state to parse, extract, and coerce message arguments.">o2_extract_start</a>, then for each parameter, call <a class="el" href="group__lowlevelparse.html#ga639a79ba06d7bf9fda5f255b00e663b4" title="get the next message parameter">o2_get_next</a>.</p>
<p >get ready to extract args with o2_get_next returns length of type string (not including ',') in message </p>

</div>
</div>
<a id="ga639a79ba06d7bf9fda5f255b00e663b4" name="ga639a79ba06d7bf9fda5f255b00e663b4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga639a79ba06d7bf9fda5f255b00e663b4">&#9670;&nbsp;</a></span>o2_get_next()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="union_o2arg.html">O2arg_ptr</a> o2_get_next </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__basics.html#ga19ed1e45bd9c566270c0836d9ec95155">O2type</a>&#160;</td>
          <td class="paramname"><em>to_type</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>get the next message parameter </p>
<p >This function is called repeatedly to obtain parameters in order from the message passed to <a class="el" href="group__lowlevelparse.html#ga5743585b7234221d61a9631506403bb9" title="initialize internal state to parse, extract, and coerce message arguments.">o2_extract_start</a>.</p>
<p >If the message parameter type matches the <code>type_code</code>, a pointer to the parameter is returned. If the types do not match, but coercion is possible, the parameter is coerced, copied to a new location, and a pointer is returned. Otherwise, NULL is returned.</p>
<p >The type of any non-NULL return value always matches the type specified by the parameter <code>type_code</code>. To determine the original type of the parameter as specified by the message, use the <code>types</code> string which is passed to message handlers. (Or course, this assumes that message type strings are correct. Badly formed messages are detected when the type string and data imply that the message is longer than the actual length, but otherwise there is no way to detect errors in type strings.)</p>
<p >The result points into the message or to a statically allocated buffer if type coercion is required. This storage is valid until the next call to <code>o2_extract_start</code>. If the value is a pointer (string, symbol, midi data, blob), then the value was not copied and remains in place within the message, so there should never be the need to immediately copy the data pointed to. However, since the storage for the value is the message, and the message will be freed when the handler returns, pointers to strings, symbols, midi data, and blobs <em>must not</em> be used after the handler returns.</p>
<h3><a class="anchor" id="autotoc_md0"></a>
Example 1: Simple but not completely robust</h3>
<p >Note: call <a class="el" href="group__basics.html#gabcdea927caeb653b4f9784955f5dcdb4" title="Add a handler for an address.">o2_method_new</a> with type_spec = "id", h = my_handler, coerce = false, parse = false. In this case, since there is no type coercion, type_spec must match the message exactly, so <a class="el" href="group__lowlevelparse.html#ga639a79ba06d7bf9fda5f255b00e663b4" title="get the next message parameter">o2_get_next</a> should always return a non-null O2arg_ptr. However, this code can fail if a badly formed message is sent because there is no test for the NULL value that will be returned by <a class="el" href="group__lowlevelparse.html#ga639a79ba06d7bf9fda5f255b00e663b4" title="get the next message parameter">o2_get_next</a>. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> my_handler(<a class="code hl_struct" href="struct_o2message.html">O2message_ptr</a> msg, <span class="keywordtype">char</span> *types,</div>
<div class="line">               <a class="code hl_union" href="union_o2arg.html">O2arg_ptr</a> *argv, <span class="keywordtype">int</span> argc, <span class="keywordtype">void</span> *user_data)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_function" href="group__lowlevelparse.html#ga5743585b7234221d61a9631506403bb9">o2_extract_start</a>(msg);</div>
<div class="line">    <span class="comment">// we expect an int32 and a double argument</span></div>
<div class="line">    int32_t my_int = <a class="code hl_function" href="group__lowlevelparse.html#ga639a79ba06d7bf9fda5f255b00e663b4">o2_get_next</a>(<a class="code hl_enumvalue" href="group__basics.html#gga19ed1e45bd9c566270c0836d9ec95155a7a4c57b8137f8280de6cdd1bb1951c12">O2_INT32</a>)-&gt;<a class="code hl_variable" href="union_o2arg.html#af6028a3f6ffdacdd55723f49a18b6d2a">i32</a>;</div>
<div class="line">    <span class="keywordtype">double</span> my_double = <a class="code hl_function" href="group__lowlevelparse.html#ga639a79ba06d7bf9fda5f255b00e663b4">o2_get_next</a>(<a class="code hl_enumvalue" href="group__basics.html#gga19ed1e45bd9c566270c0836d9ec95155a55a97103f771efb8d069ce96f1f3aae2">O2_DOUBLE</a>)-&gt;<a class="code hl_variable" href="union_o2arg.html#affd54f2466c8511a7004988a408ece2b">d</a>;</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="ttc" id="agroup__basics_html_gga19ed1e45bd9c566270c0836d9ec95155a55a97103f771efb8d069ce96f1f3aae2"><div class="ttname"><a href="group__basics.html#gga19ed1e45bd9c566270c0836d9ec95155a55a97103f771efb8d069ce96f1f3aae2">O2_DOUBLE</a></div><div class="ttdeci">@ O2_DOUBLE</div><div class="ttdoc">64 bit IEEE-754 double.</div><div class="ttdef"><b>Definition:</b> o2.h:729</div></div>
<div class="ttc" id="agroup__basics_html_gga19ed1e45bd9c566270c0836d9ec95155a7a4c57b8137f8280de6cdd1bb1951c12"><div class="ttname"><a href="group__basics.html#gga19ed1e45bd9c566270c0836d9ec95155a7a4c57b8137f8280de6cdd1bb1951c12">O2_INT32</a></div><div class="ttdeci">@ O2_INT32</div><div class="ttdoc">32 bit signed integer.</div><div class="ttdef"><b>Definition:</b> o2.h:719</div></div>
<div class="ttc" id="agroup__lowlevelparse_html_ga5743585b7234221d61a9631506403bb9"><div class="ttname"><a href="group__lowlevelparse.html#ga5743585b7234221d61a9631506403bb9">o2_extract_start</a></div><div class="ttdeci">int o2_extract_start(o2_msg_data_ptr msg)</div><div class="ttdoc">initialize internal state to parse, extract, and coerce message arguments.</div><div class="ttdef"><b>Definition:</b> message.cpp:869</div></div>
<div class="ttc" id="agroup__lowlevelparse_html_ga639a79ba06d7bf9fda5f255b00e663b4"><div class="ttname"><a href="group__lowlevelparse.html#ga639a79ba06d7bf9fda5f255b00e663b4">o2_get_next</a></div><div class="ttdeci">O2arg_ptr o2_get_next(O2type to_type)</div><div class="ttdoc">get the next message parameter</div><div class="ttdef"><b>Definition:</b> message.cpp:1018</div></div>
<div class="ttc" id="astruct_o2message_html"><div class="ttname"><a href="struct_o2message.html">O2message</a></div><div class="ttdoc">an O2 message container</div><div class="ttdef"><b>Definition:</b> o2.h:690</div></div>
<div class="ttc" id="aunion_o2arg_html"><div class="ttname"><a href="union_o2arg.html">O2arg</a></div><div class="ttdoc">union of all O2 parameter types</div><div class="ttdef"><b>Definition:</b> o2.h:764</div></div>
<div class="ttc" id="aunion_o2arg_html_af6028a3f6ffdacdd55723f49a18b6d2a"><div class="ttname"><a href="union_o2arg.html#af6028a3f6ffdacdd55723f49a18b6d2a">O2arg::i32</a></div><div class="ttdeci">int32_t i32</div><div class="ttdoc">32 bit signed integer.</div><div class="ttdef"><b>Definition:</b> o2.h:765</div></div>
<div class="ttc" id="aunion_o2arg_html_affd54f2466c8511a7004988a408ece2b"><div class="ttname"><a href="union_o2arg.html#affd54f2466c8511a7004988a408ece2b">O2arg::d</a></div><div class="ttdeci">double d</div><div class="ttdoc">64 bit IEEE-754 double.</div><div class="ttdef"><b>Definition:</b> o2.h:771</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md1"></a>
Example 2: Type coercion and type checking.</h3>
<p >Note: call <a class="el" href="group__basics.html#gabcdea927caeb653b4f9784955f5dcdb4" title="Add a handler for an address.">o2_method_new</a> with type_spec = NULL, h = my_handler, coerce = false, parse = false. In this case, even though coerce is false, there is no type_spec, so the handler will be called without type checking. We could check the actual message types (given by types), but here, we will coerce into our desired types (int32 and double) if possible. Since type coercion can fail (e.g. string will not be converted to number, not even "123"), we need to check the return value from <a class="el" href="group__lowlevelparse.html#ga639a79ba06d7bf9fda5f255b00e663b4" title="get the next message parameter">o2_get_next</a>, where NULL indicates incompatible types. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> my_handler(<a class="code hl_struct" href="struct_o2message.html">O2message_ptr</a> msg, <span class="keywordtype">char</span> *types,</div>
<div class="line">               <a class="code hl_union" href="union_o2arg.html">O2arg_ptr</a> *argv, <span class="keywordtype">int</span> argc, <span class="keywordtype">void</span> *user_data)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_function" href="group__lowlevelparse.html#ga5743585b7234221d61a9631506403bb9">o2_extract_start</a>(msg);</div>
<div class="line">    <span class="comment">// we want to get an int32 and a double argument</span></div>
<div class="line">    <a class="code hl_union" href="union_o2arg.html">O2arg_ptr</a> ap = <a class="code hl_function" href="group__lowlevelparse.html#ga639a79ba06d7bf9fda5f255b00e663b4">o2_get_next</a>(<a class="code hl_enumvalue" href="group__basics.html#gga19ed1e45bd9c566270c0836d9ec95155a7a4c57b8137f8280de6cdd1bb1951c12">O2_INT32</a>);</div>
<div class="line">    <span class="keywordflow">if</span> (!ap) <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__returncodes.html#ggae9a85a9a12082ae659af9d047d6d63c9af3cd38a1ac5bca4865c3f0c7586ab0c8">O2_FAIL</a>; <span class="comment">// parameter cannot be coerced</span></div>
<div class="line">    int32_t my_int = ap-&gt;<a class="code hl_variable" href="union_o2arg.html#af6028a3f6ffdacdd55723f49a18b6d2a">i32</a>;</div>
<div class="line">    <a class="code hl_union" href="union_o2arg.html">O2arg_ptr</a> ap = <a class="code hl_function" href="group__lowlevelparse.html#ga639a79ba06d7bf9fda5f255b00e663b4">o2_get_next</a>(<a class="code hl_enumvalue" href="group__basics.html#gga19ed1e45bd9c566270c0836d9ec95155a55a97103f771efb8d069ce96f1f3aae2">O2_DOUBLE</a>);</div>
<div class="line">    <span class="keywordflow">if</span> (!ap) <span class="keywordflow">return</span> <a class="code hl_enumvalue" href="group__returncodes.html#ggae9a85a9a12082ae659af9d047d6d63c9af3cd38a1ac5bca4865c3f0c7586ab0c8">O2_FAIL</a>; <span class="comment">// parameter cannot be coerced</span></div>
<div class="line">    <span class="keywordtype">double</span> my_double = ap-&gt;<a class="code hl_variable" href="union_o2arg.html#affd54f2466c8511a7004988a408ece2b">d</a>;</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="ttc" id="agroup__returncodes_html_ggae9a85a9a12082ae659af9d047d6d63c9af3cd38a1ac5bca4865c3f0c7586ab0c8"><div class="ttname"><a href="group__returncodes.html#ggae9a85a9a12082ae659af9d047d6d63c9af3cd38a1ac5bca4865c3f0c7586ab0c8">O2_FAIL</a></div><div class="ttdeci">@ O2_FAIL</div><div class="ttdoc">a non-specific error occurred.</div><div class="ttdef"><b>Definition:</b> o2.h:339</div></div>
</div><!-- fragment --><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">type_code</td><td>the desired parameter type</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>the next message parameter or NULL if no more parameters</dd></dl>
<p>get the next argument from the message. If the to_type does not match the actual type in the message, convert if possible; otherwise, return NULL for the O2arg_ptr. Note that if coerce_flag was false, the type checking will have compared types for an exact match, so if we make it this far and we are constructing argv, then no type coercion will take place (and the tests for type matching are all redundant because they will all fail). If client code is calling this, then there is no way to turn off type coercion except that you can compare your desired to_type to the character in the actual type string and if there is no match, do not call <a class="el" href="group__lowlevelparse.html#ga639a79ba06d7bf9fda5f255b00e663b4" title="get the next message parameter">o2_get_next()</a>. </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
